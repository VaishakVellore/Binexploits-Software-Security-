#include <stdio.h>
#include <string.h>
#include <sys/types.h>
#include <pwd.h>
#include <unistd.h>

char *checkmsg(char *msg) 
{
  struct {
  int i;
  char *pos;
  int len;
  char mymsg[256];
  } stack;

  stack.len = 0;

  stack.len = strlen(msg) < 256 ? strlen(msg) : 256;
  for(stack.i = 0; stack.i <= stack.len; stack.i++) {
    stack.mymsg[stack.i] = msg[stack.i]; 
  }
  
  while ((stack.pos = strchr(stack.mymsg, 0x0d))) {
    *stack.pos = '-';
  }
  while ((stack.pos = strchr(stack.mymsg, 0x0a))) {
    *stack.pos = '-';
  }
  while ((stack.pos = strchr(stack.mymsg, 0x25))) {
    *stack.pos = '-';
  }

  return strdup(stack.mymsg);
}

char *sanitize(char* user, char *msg)
{
    
  if (strncmp(user, msg, strlen(user)) == 0) {
    msg += strlen(user);
  }

  return checkmsg(msg);
}

int main(int argc, char *argv[]) 
{
  struct passwd* dest = NULL; 
  struct passwd* src = NULL; 
  char *username = NULL;
  char msgline[1024];
  char msgfile[1024];
  char *msg = NULL;
  char *dest_dir;
  FILE *f = NULL;

  if (argc < 3) {
    printf("missing args\n");
    return -1;
  }
  
  msg = sanitize(argv[1], argv[2]);
  if (msg == NULL) {
    fprintf(stderr, "Cannot sanitize message\n"); 
    return -1; 
  }                                                   
    
  username = argv[1];
  dest = getpwnam(username);                         
  if (dest == NULL) {                                
    fprintf(stderr, "Non-existent username %s\n", username); 
    return -1; 
  }                                                   
  dest_dir = strdup(dest->pw_dir);

  src = getpwuid(getuid());                         
  if (src == NULL) {                                
    fprintf(stderr, "Non-existent uid %d\n", getuid()); 
    return -1; 
  }                                                   
  snprintf(msgline, 1024, "From %s: %s\n", src->pw_name, msg);
  snprintf(msgfile, 1024, "%s/.messages", dest_dir);
  
  if ((f = fopen(msgfile, "a")) == NULL) {
    fprintf(stderr, "Cannot open file %s\n", msgfile); 
    return -1; 
  }                                                   
    
  fprintf(f, msgline);
  fclose(f);
  
  return 0;
}
