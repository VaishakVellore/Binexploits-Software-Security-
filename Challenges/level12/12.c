#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>
#include <sys/types.h>

int sudoexec(char *command)
{
  FILE *f = NULL;
  char log_entry[64];
  char line[256];

  f = fopen("/var/challenge/level12/sudolog", "a+");
  if (f == NULL) {
    fprintf(stderr, "Can't open sudolog file\n");
    return -1;
  }
  snprintf(log_entry, 64, "%d: %s\n", getuid(), command);
  
  fprintf(f, log_entry);
  fclose(f);

  f = fopen("/var/challenge/level12/sudoers", "r");
  if (f == NULL) {
    fprintf(stderr, "Can't open sudoers file\n");
    return -1;
  }

  while(fgets(line, 256, f) != NULL) { 
    if (atoi(line) == getuid()) {
      if (setuid(0) == 0) {
        system(command);
        return 0;
      } 
      else {
        fprintf(stderr, "Setting the UID to root failed: check permissions\n");
        fclose(f);
        return -1;
      }
    }
  } 

  fprintf(stderr, "User not listed in the sudoers file\n");
  fclose(f);

  return -1;
}

int main (int argc, char** argv)
{

  if (argv[1] == NULL)
    {
      fprintf(stderr, "Missing args\n");
      return -1;
    }
  
  if (sudoexec(argv[1]) != 0)
    {
      fprintf(stderr, "Cannot execute your command");
      return -1;
    }
  return 0;
}
